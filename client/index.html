<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ursceal</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-left">
      <h1>Úrscéal</h1>
      <div class="story-controls">
        <select id="storySelector" class="story-selector">
          <option>Loading...</option>
        </select>
        <button id="newStoryBtn" class="btn btn-small btn-primary" title="Create New Story">+</button>
      </div>
    </div>
    <div class="header-right">
      <button id="settingsBtn" class="icon-btn" title="Settings">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 6a2 2 0 100-4 2 2 0 000 4zM10 12a2 2 0 100-4 2 2 0 000 4zM10 18a2 2 0 100-4 2 2 0 000 4z" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Character Card Section -->
      <section class="sidebar-section">
        <h2>Story Characters</h2>
        <button id="characterLibraryBtn" class="btn btn-secondary" style="margin-bottom: 0.5rem;">
          Character Library
        </button>

        <input type="file" id="characterUpload" accept="image/png" style="display: none;">

        <div id="characterInfo" class="character-info hidden">
          <div class="character-avatar" id="characterAvatar"></div>
          <div class="character-details">
            <h3 id="characterName">No Character</h3>
            <p id="characterDesc" class="character-desc"></p>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
            <label for="characterUpload" class="btn btn-small btn-primary" style="text-align: center; margin: 0;">
              Import New
            </label>
            <button id="clearCharacterBtn" class="btn btn-small btn-secondary">Remove All</button>
          </div>
        </div>
        <div id="noCharacter" class="no-character">
          <p>No characters in this story</p>
          <label for="characterUpload" class="btn btn-primary">
            Import Character Card
          </label>
        </div>
      </section>

      <!-- Persona Section -->
      <section class="sidebar-section">
        <h2>Persona</h2>
        <button id="selectPersonaBtn" class="btn btn-secondary">Select Character</button>
        <div id="personaSummary" class="persona-summary">
          <p id="personaName">Not set</p>
          <p id="personaType" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;"></p>
        </div>
      </section>

      <!-- Generation Controls -->
      <section class="sidebar-section">
        <h2>Generate Content</h2>
        <div class="generation-buttons">
          <button id="continueStoryBtn" class="btn btn-primary" disabled>
            Continue Story
          </button>
          <button id="characterResponseBtn" class="btn btn-primary" disabled>
            Character Response
          </button>
          <button id="customPromptBtn" class="btn btn-secondary" disabled>
            Custom Prompt
          </button>
          <button id="rewriteThirdPersonBtn" class="btn btn-secondary" disabled>
            Rewrite to Third Person
          </button>
        </div>
        <div id="generationStatus" class="generation-status hidden">
          <div class="spinner"></div>
          <span id="statusText">Generating...</span>
        </div>
        <button id="viewPromptBtn" class="btn btn-secondary btn-small hidden" style="margin-top: 0.5rem;">
          View Last Prompt
        </button>
      </section>

      <!-- Document Controls -->
      <section class="sidebar-section">
        <h2>Document</h2>
        <div class="document-buttons">
          <button id="saveBtn" class="btn btn-secondary">Save</button>
          <button id="loadBtn" class="btn btn-secondary">Load</button>
          <button id="clearBtn" class="btn btn-secondary">Clear</button>
          <button id="exportBtn" class="btn btn-secondary">Export TXT</button>
        </div>
      </section>
    </aside>

    <!-- Main Content Area -->
    <main class="content-area">
      <!-- Editor -->
      <div class="editor-container">
        <textarea id="storyEditor" class="story-editor"
          placeholder="Import a character card to begin, or start writing your story here..."
          spellcheck="true"></textarea>
      </div>

      <!-- Reasoning Panel (Toggleable) -->
      <div id="reasoningPanel" class="reasoning-panel hidden">
        <div class="reasoning-header">
          <h3>Model Reasoning</h3>
          <button id="closeReasoningBtn" class="icon-btn">×</button>
        </div>
        <div id="reasoningContent" class="reasoning-content">
          <p class="reasoning-empty">No reasoning to display yet. Generate content to see how the model thinks.</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="apiKeyInput">DeepSeek API Key</label>
          <input type="password" id="apiKeyInput" class="input-field" placeholder="sk-...">
          <small>Your API key is stored locally and never sent anywhere except DeepSeek's API.</small>
        </div>

        <div class="form-group">
          <label for="maxTokensInput">Max Tokens per Generation</label>
          <input type="number" id="maxTokensInput" class="input-field" value="4000" min="100" max="8000">
          <small>Higher values allow longer generations but cost more.</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="showReasoningToggle">
            <span>Show reasoning panel</span>
          </label>
          <small>Display the model's thinking process alongside generated content.</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="autoSaveToggle" checked>
            <span>Auto-save document</span>
          </label>
          <small>Automatically save your work every 30 seconds.</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="showPromptToggle">
            <span>Show prompt viewer</span>
          </label>
          <small>Display a button to view the full prompt sent to the API.</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="thirdPersonToggle" checked>
            <span>Enforce third-person past tense</span>
          </label>
          <small>Write in third-person past tense perspective (he/she/they said, walked, etc.). No present tense or
            first person.</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="filterAsterisksToggle" checked>
            <span>Filter asterisks (*)</span>
          </label>
          <small>Remove asterisks from character cards and generated content (common in RP chats but not novel-style
            writing).</small>
        </div>
      </div>
      <div class="modal-footer">
        <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
        <button class="btn btn-secondary close-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Character Editor Modal -->
  <div id="characterModal" class="modal hidden">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 id="characterModalTitle">Edit Character</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="form-group">
          <label for="charImageInput">Character Image (Optional)</label>
          <input type="file" id="charImageInput" class="input-field" accept="image/png,image/jpeg,image/jpg" style="padding: 0.4rem;">
          <small>Optional: Upload an image for this character</small>
        </div>

        <div class="form-group">
          <label for="charNameInput">Name</label>
          <input type="text" id="charNameInput" class="input-field" placeholder="Character name">
        </div>

        <div class="form-group">
          <label for="charDescInput">Description</label>
          <textarea id="charDescInput" class="input-field textarea-field" rows="4"
            placeholder="Physical appearance, background, biography..."></textarea>
          <small>Can use {{user}} for persona name</small>
        </div>

        <div class="form-group">
          <label for="charPersonalityInput">Personality</label>
          <textarea id="charPersonalityInput" class="input-field textarea-field" rows="4"
            placeholder="Personality traits, mannerisms, speech patterns..."></textarea>
        </div>

        <div class="form-group">
          <label for="charScenarioInput">Scenario</label>
          <textarea id="charScenarioInput" class="input-field textarea-field" rows="3"
            placeholder="Current situation, setting, context..."></textarea>
          <small>Can use {{user}} and {{char}}/{{character}} placeholders</small>
        </div>

        <div class="form-group">
          <label for="charFirstMesInput">First Message</label>
          <textarea id="charFirstMesInput" class="input-field textarea-field" rows="4"
            placeholder="Initial greeting or opening scene..."></textarea>
        </div>

        <div class="form-group">
          <label for="charMesExampleInput">Dialogue Examples</label>
          <textarea id="charMesExampleInput" class="input-field textarea-field" rows="5"
            placeholder="Example dialogue to guide writing style..."></textarea>
          <small>Optional: Examples of how the character speaks</small>
        </div>

        <div class="form-group">
          <label for="charSystemPromptInput">System Prompt (Advanced)</label>
          <textarea id="charSystemPromptInput" class="input-field textarea-field" rows="3"
            placeholder="Custom system instructions..."></textarea>
          <small>Optional: Override default system prompt</small>
        </div>

        <div class="form-group">
          <label for="charPostHistoryInput">Post-History Instructions (Advanced)</label>
          <textarea id="charPostHistoryInput" class="input-field textarea-field" rows="3"
            placeholder="Instructions added after conversation history..."></textarea>
          <small>Optional: Strong influence on generation style</small>
        </div>
      </div>
      <div class="modal-footer">
        <button id="saveCharacterBtn" class="btn btn-primary">Save Character</button>
        <button class="btn btn-secondary close-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Custom Prompt Modal -->
  <div id="customPromptModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Custom Prompt</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="customPromptInput">What would you like to generate?</label>
          <textarea id="customPromptInput" class="input-field textarea-field" rows="5"
            placeholder="Example: Describe the ancient castle in vivid detail, focusing on its mysterious history..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="generateCustomBtn" class="btn btn-primary">Generate</button>
        <button class="btn btn-secondary close-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Persona Selector Modal -->
  <div id="personaSelectorModal" class="modal hidden">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
      <div class="modal-header">
        <h2>Select Persona for This Story</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
          Choose a character from your library to use as the persona (narrator perspective) for this story.
        </p>
        <div id="personaSelectorGrid" class="character-library-grid">
          <p class="text-secondary">Loading characters...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="clearPersonaBtn" class="btn btn-secondary">Clear Persona</button>
        <button class="btn btn-secondary close-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Character Library Modal -->
  <div id="characterLibraryModal" class="modal hidden">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
      <div class="modal-header">
        <h2>Character Library</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
          <button id="createCharacterBtn" class="btn btn-primary">Create New Character</button>
          <label for="characterUploadLibrary" class="btn btn-secondary" style="margin: 0;">
            Import PNG
          </label>
          <input type="file" id="characterUploadLibrary" accept="image/png" style="display: none;">
        </div>
        <div id="characterLibraryGrid" class="character-library-grid">
          <p class="text-secondary">Loading characters...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Prompt Viewer Modal -->
  <div id="promptViewerModal" class="modal hidden">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Last Prompt Sent to API</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>System Prompt</label>
          <textarea id="systemPromptDisplay" class="input-field textarea-field" rows="10" readonly
            style="font-family: monospace; font-size: 0.8rem;"></textarea>
        </div>
        <div class="form-group">
          <label>User Prompt</label>
          <textarea id="userPromptDisplay" class="input-field textarea-field" rows="10" readonly
            style="font-family: monospace; font-size: 0.8rem;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Scripts -->
  <script src="/shared/tavern-parser.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/app.js"></script>
</body>

</html>